"use strict";function routers(e){var t=this;e.get("/api/portals",function(e,n){return __awaiter(t,void 0,void 0,function(){var e,t,r,s,o,a;return __generator(this,function(u){switch(u.label){case 0:return u.trys.push([0,6,,7]),[4,mongo_1.db.getPortals()];case 1:e=u.sent(),t=0,r=e,u.label=2;case 2:return t<r.length?(s=r[t],o=s,[4,mongo_1.db.getCategoriesByListIDs(s.categories)]):[3,5];case 3:o.categories=u.sent(),u.label=4;case 4:return t++,[3,2];case 5:return n.status(200),n.send(JSON.stringify(e)),[3,7];case 6:return a=u.sent(),n.status(500),n.send(a),[3,7];case 7:return[2]}})})}),e.get("/api/portal/:id",function(e,n){return __awaiter(t,void 0,void 0,function(){var t,r,s;return __generator(this,function(o){switch(o.label){case 0:return o.trys.push([0,3,,4]),[4,mongo_1.db.getPortalByID(e.params.id)];case 1:return t=o.sent(),r=t,[4,mongo_1.db.getCategoriesByListIDs(t.categories)];case 2:return r.categories=o.sent(),n.status(200),n.send(JSON.stringify(t)),[3,4];case 3:return s=o.sent(),n.status(500),n.send(s),[3,4];case 4:return[2]}})})}),e.get("/api/categories",function(e,t){mongo_1.db.getCategories().then(function(e){t.status(200),t.send(JSON.stringify(e))}).catch(function(e){t.status(500),t.send(e)})}),e.get("/api/category/:id",function(e,t){mongo_1.db.getCategoryByID(e.params.id).then(function(e){t.status(200),t.send(JSON.stringify(e))}).catch(function(e){t.status(500),t.send(e)})}),e.get("/api/products/:id",function(e,n){return __awaiter(t,void 0,void 0,function(){var t,r,s;return __generator(this,function(o){switch(o.label){case 0:return o.trys.push([0,3,,4]),[4,mongo_1.db.getCategoryByID(e.params.id)];case 1:return t=o.sent(),[4,mongo_1.db.getAllProductsByCategoryID(e.params.id)];case 2:return r=o.sent(),n.status(200).send(JSON.stringify({category:t,products:r})),[3,4];case 3:return s=o.sent(),n.status(500).send(s),[3,4];case 4:return[2]}})})}),e.get("/api/product/:id",function(e,t){mongo_1.db.getProductByID(e.params.id).then(function(e){e.isShow?(t.status(200),t.send(JSON.stringify(e))):t.status(404).end()}).catch(function(e){t.status(500),t.send(e)})}),e.get("/api/recommended",function(e,t){mongo_1.db.getAllProductsByRecom().then(function(e){t.status(200),t.send(JSON.stringify(e))}).catch(function(e){t.status(500),t.send(e)})}),e.get("/api/delivery",function(e,t){mongo_1.db.getDelivery().then(function(e){t.status(200),e?t.send(e.text):t.send()}).catch(function(e){t.status(500),t.send(e)})}),e.get("/api/about",function(e,t){mongo_1.db.getAbout().then(function(e){t.status(200),e?t.send(e.text):t.send()}).catch(function(e){t.status(500),t.send(e)})}),e.get("/api/contact",function(e,t){mongo_1.db.getContact().then(function(e){t.status(200),e?t.send(e.text):t.send()}).catch(function(e){t.status(500),t.send(e)})}),e.get("/api/greet",function(e,t){mongo_1.db.getGreet().then(function(e){t.status(200),e?t.send(e.text):t.send()}).catch(function(e){t.status(500),t.send(e)})}),e.get("/api/news",function(e,t){mongo_1.db.getNews().then(function(e){t.status(200),t.send(JSON.stringify(e))}).catch(function(e){t.status(500),t.send(e)})}),e.post("/api/auth",function(e,t,n){passport.authenticate("userEnter",function(n,r,s){return n?t.status(500).json(n):r?void e.logIn(r,function(e){if(e)return t.status(500).json(n);delete r.password,t.json(r)}):t.status(401).json("ошибка авторизации")})(e,t,n)}),e.post("/api/reg",function(e,t){e.body||t.status(500).send("error body parse"),"string"==typeof e.body.username&&"string"==typeof e.body.password&&"string"==typeof e.body.email?mongo_1.db.getUserByName(e.body.username).then(function(n){if(n)throw t.status(409).send(),new Error("stop");return mongo_1.db.addUser({username:e.body.username,password:e.body.password,email:e.body.email,date:Date.now(),image:"userpic.jpg",adress:"",phone:"",note:"",discount:0})}).then(function(e){t.status(200).send()}).catch(function(e){"stop"!=e.message&&(t.status(500),t.send(e))}):t.status(500).send("error body parse")}),e.get("/api/checkAuth",function(e,t){var n=e.user;n?(delete n.password,t.status(200).send(n)):t.status(401).send()}),e.get("/api/logout",function(e,t){e.session.destroy(function(){t.clearCookie("connect.sid"),t.redirect("/")})}),e.post("/api/recovery",function(e,n){return __awaiter(t,void 0,void 0,function(){var t,r,s,o,a,u;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,9,,10]),[4,mongo_1.db.recoveryPassword(e.body.email)];case 1:return(t=i.sent())?(r=Math.random().toString(36).slice(-8),sha1(r),s=sha1.create(),s.update(r),o=s.hex(),t.password=o,[4,mongo_1.db.updateUser(t._id,t)]):[3,7];case 2:i.sent(),n.status(200).end(),i.label=3;case 3:return i.trys.push([3,5,,6]),[4,mail_1.sendNewPasswordMail(t,r)];case 4:return i.sent(),[3,6];case 5:return a=i.sent(),[3,6];case 6:return[3,8];case 7:n.status(403).send("no user"),i.label=8;case 8:return[3,10];case 9:return u=i.sent(),n.status(500).send("Server error"),[3,10];case 10:return[2]}})})}),e.get("/api/search",function(e,t){e.query.search||t.status(404).send(),e.query.search.length>=3?mongo_1.db.getAllProductsBySearchRequest(escape(e.query.search)).then(function(e){t.status(200).send(JSON.stringify(e))}).catch(function(e){t.status(500).send("DB error")}):t.status(200).send(JSON.stringify([]))}),e.post("/api/profile",function(e,t){new Promise(function(t,n){if(!e.user)return void n("no_authorization");(new formidable.IncomingForm).parse(e,function(r,s,o){if(r)return void n("no_authorization");if(!s.password||s.password!=e.user.password)return void n("wrong_password");var a={username:e.user.username,email:e.user.email};if(s.new_password&&(a.password=s.new_password),s.adress&&(a.adress=s.adress),s.phone&&(a.phone=s.phone),s.secondphone&&(a.secondphone=s.secondphone),s.fio&&(a.fio=s.fio),o.image){var u=o.image.name.split("."),i=Date.now().toString()+"."+u[u.length-1];move(o.image.path,config_1.config.PathtoPublic+"userpics/"+i,function(e){e&&t(a),a.image=i,t(a)})}else t(a)})}).then(function(t){return mongo_1.db.updateUser(e.user._id,t)}).then(function(t){return mongo_1.db.getUserByID(e.user._id)}).then(function(e){delete e.password,t.status(200),t.send(JSON.stringify(e))}).catch(function(e){switch(e){case"no_authorization":t.status(401).send();break;case"wrong_password":t.status(422).send();break;default:t.status(500).send(JSON.stringify({err:e}))}})}),e.post("/api/order",function(e,n){return __awaiter(t,void 0,void 0,function(){var t,r,s,o,a,u,i,c,d,g,f,p,h,l,y,b,_,m;return __generator(this,function(w){switch(w.label){case 0:if(w.trys.push([0,8,,9]),!e.body.user||!e.body.user.phone||e.body.user.phone.length<5||!e.body.order||e.body.order.length<1)throw new Error("empty_body");return t=e.body.order.map(function(e){return e._id}),[4,mongo_1.db.getProductsByListIDs(t)];case 1:for(r=w.sent(),s=0;s<r.length;s++)for(o=0;o<e.body.order.length;o++)r[s]._id==e.body.order[o]._id&&(r[s].count=e.body.order[o].count);if(e.body.order=r,a=e.user?+e.user.discount:0,a&&(e.body.user.discount=a),0!=a){for(u=[],i=0,c=e.body.order;i<c.length;i++)d=c[i],g=+d.price,f=g*a/100,d.price=+(g-f).toFixed(2),u.push(d);e.body.order=u}return[4,mongo_1.db.getOrdersCountNext()];case 2:for(p=w.sent(),p=p.value?p.value.count:1,e.body.orderNumber=+p,e.body.time=new Date,e.body.status="wait",h=0,l=0,y=e.body.order;l<y.length;l++)b=y[l],h+=b.price*b.count;return e.body.sum=h,[4,mongo_1.db.addOrder(e.body)];case 3:return w.sent(),e.body.user.email&&""!=e.body.user.email?(n.status(200).send(JSON.stringify({number:p})),[4,mail_1.sendMail(e.body.user,e.body.order,p)]):[3,6];case 4:return _=w.sent(),[4,mongo_1.db.addMailResult(_)];case 5:return w.sent(),[3,7];case 6:n.status(200).send(JSON.stringify({number:p})),w.label=7;case 7:return[3,9];case 8:return m=w.sent(),"empty_body"!=m.message?n.status(501).send():n.status(500).send(),[3,9];case 9:return[2]}})})}),e.get("/api/history",function(e,n){return __awaiter(t,void 0,void 0,function(){var t,r;return __generator(this,function(s){switch(s.label){case 0:if(s.trys.push([0,2,,3]),!e.user)throw new Error("no_auth");return[4,mongo_1.db.getOrdersByUser(e.user.username)];case 1:return t=s.sent(),n.status(200),n.send(JSON.stringify(t)),[3,3];case 2:return r=s.sent(),n.status(403).send("No auth"),[3,3];case 3:return[2]}})})}),e.get("/api/history/:id",function(e,n){return __awaiter(t,void 0,void 0,function(){var t,r,s;return __generator(this,function(o){switch(o.label){case 0:if(o.trys.push([0,2,,3]),!e.user)throw new Error("no_auth.");return[4,mongo_1.db.getOrderById(e.params.id)];case 1:if(t=o.sent(),0==t.length)throw new Error("Wrong request.");return r=t[0].order.map(function(e){return{count:e.count,name:e.name,price:e.price,_id:e._id}}),n.status(200),n.send(JSON.stringify(r)),[3,3];case 2:return s=o.sent(),n.status(500).send("error.message"),[3,3];case 3:return[2]}})})}),e.get("/api/banners",function(e,n){return __awaiter(t,void 0,void 0,function(){var e,t;return __generator(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,mongo_1.db.getBanners()];case 1:return e=r.sent(),n.status(200),n.send(JSON.stringify(e)),[3,3];case 2:return t=r.sent(),n.status(500).send("Server error"),[3,3];case 3:return[2]}})})}),e.post("/api/debug",function(e,t){mongo_1.db.addDebugInfo(e.body).then(function(){t.status(200),t.send()}).catch(function(){t.status(500),t.send()})}),e.use(function(e,t,n){t.status(400),t.send("wrong api request")})}var __awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(s,o){function a(e){try{i(r.next(e))}catch(e){o(e)}}function u(e){try{i(r.throw(e))}catch(e){o(e)}}function i(e){e.done?s(e.value):new n(function(t){t(e.value)}).then(a,u)}i((r=r.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return r([e,t])}}function r(n){if(s)throw new TypeError("Generator is already executing.");for(;i;)try{if(s=1,o&&(a=o[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return i.label++,{value:n[1],done:!1};case 5:i.label++,o=n[1],n=[0];continue;case 7:n=i.ops.pop(),i.trys.pop();continue;default:if(a=i.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){i=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){i.label=n[1];break}if(6===n[0]&&i.label<a[1]){i.label=a[1],a=n;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(n);break}a[2]&&i.ops.pop(),i.trys.pop();continue}n=t.call(e,i)}catch(e){n=[6,e],o=0}finally{s=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var s,o,a,u,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return u={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u};exports.__esModule=!0;var formidable=require("formidable"),passport=require("passport"),move=require("mv"),escape=require("escape-string-regexp"),sha1=require("js-sha1"),mongo_1=require("./mongo"),mail_1=require("./mail"),config_1=require("../config");exports.routers=routers;